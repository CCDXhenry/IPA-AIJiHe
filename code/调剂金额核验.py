import pandas as pd
import logging
import os

df_费用结算数据稽核 = pd.read_excel(file_path_费用结算数据稽核, sheet_name='合作费用业务明细查询0')
df_调剂明细数据 = pd.read_excel(file_path_调剂明细数据)

df_费用结算数据稽核_调剂金额小于0 = df_费用结算数据稽核[df_费用结算数据稽核['调剂金额'] < 0]

#df_调剂明细数据按照用户号码、政策分期小项编码、机构号分组统计调剂金额，与df_费用结算数据稽核_调剂金额小于0用户号码、政策分期小项编码、机构号对应的调剂金额对比是否一致
# 分组统计调剂金额
df_调剂明细数据_汇总 = df_调剂明细数据.groupby(['用户号码', '政策分期小项编码', '机构号'])['调剂金额'].sum().reset_index()
df_费用结算数据稽核_汇总 = df_费用结算数据稽核_调剂金额小于0.groupby(['用户号码', '政策分期小项编码', '机构号'])['调剂金额'].sum().reset_index()

# 重命名列以区分来源
df_调剂明细数据_汇总 = df_调剂明细数据_汇总.rename(columns={
    '调剂金额': '调剂明细金额'
})
df_费用结算数据稽核_汇总 = df_费用结算数据稽核_汇总.rename(columns={
    '调剂金额': '费用结算金额'
})

# 合并两个数据源进行比对
df_金额核验 = pd.merge(
    df_调剂明细数据_汇总,
    df_费用结算数据稽核_汇总,
    on=['用户号码', '政策分期小项编码', '机构号'],
    how='outer'
)

# 填充空值为0
df_金额核验['调剂明细金额'] = df_金额核验['调剂明细金额'].fillna(0)
df_金额核验['费用结算金额'] = df_金额核验['费用结算金额'].fillna(0)

# 计算金额差异
df_金额核验['金额差异'] = df_金额核验['调剂明细金额'] - df_金额核验['费用结算金额']

# 标记核验结果
df_金额核验['核验结果'] = '一致'
df_金额核验.loc[df_金额核验['金额差异'] != 0, '核验结果'] = '不一致'

# 输出核验结果统计
不一致数量 = (df_金额核验['核验结果'] == '不一致').sum()
总记录数 = len(df_金额核验)
logging.info(f"金额核验结果:")
logging.info(f"总记录数: {总记录数}")
logging.info(f"不一致记录数: {不一致数量}")
logging.info(f"一致记录数: {总记录数 - 不一致数量}")

# 保存核验结果
df_金额核验.to_excel(file_path_调剂金额核验结果, index=False)
logging.info(f"核验结果已保存至: {file_path_调剂金额核验结果}")

if 不一致数量 > 0:
    is_pass = False
else:
    is_pass = True


 