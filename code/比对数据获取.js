const input = document.querySelector("#pane-xmdr-curinsertdest > div > div > div > form > div:nth-child(3) > div > div > input");
input.value = '202504IAI+稽核';
input.dispatchEvent(new Event('input', { bubbles: true }));

<iframe name="#nl_tab_1" width="100%" height="100%" src="http://10.48.224.102:9005/ibop//onlineindex/out_url_view.jsp?url=687474703A2F2F31302E34382E3232342E353A393031362F62695F7765622F7472616E736665725F6E677265776172645F7765622E6A73703F766572696679636F64653D343239393238323337303732383937373739313839353736266D656E7549643D3736303039383030313334372673797366756E69643D393830303133343726706F7274616C66756E5F69643D373630303938303031333437267573657269643D33323330333133303334333233362675726C3D36323639354637373635363232463645363737323635373736313732363433333546333032463732363537303646373237343246373237373634353237303734343436353734363136393643324637313732373935323737363435323730373434343635373436313639364335363639363537373245364137333730266572726F7275726C3D3245324532463635373237323646373232453641373336362670726F787975726C3D363837343734373033413246324633313330324533343338324533323332333432453331333033323341333933303330333532463639363236463730324637333739373332463644363137323642363537343639364536373546373037323646373837393245363837343644364326726571756573745F74696D653D63333032303139313236663862363634336238663464393561616365336161662669735F6E6565645F617574683D30266D61696E5F69643D354134353445343734413535343134453441353534313445&amp;sysfunid=98001347&amp;portalfun_id=760098001347&amp;menuname=BACFD7F7B7D1D3C3D2B5CEF1C3F7CFB8B2E9D1AF&amp;tabid=nl_tab_1" frameborder="0" scrolling="" style="height: 326px; margin-top: 0px;" allowtransparency="true"></iframe>
<script type="text/javascript" platform="ibop" b_instance_id="a631fad5b540403793f2d36cf0747501" b_name="" click_id="17ceb18c773443908b025d5586b61e13_6" req_body="" req_head="YWNjZXB0OnRleHQvaHRtbCwgYXBwbGljYXRpb24veGh0bWwreG1sLCBpbWFnZS9qeHIsICovKixyZWZlcmVyOmh0dHA6Ly8xMC40OC4yMjQuMTAyOjkwMDUvaWJvcC80YXBsdWdpbi80QV9jb2NfaW5kZXhfaGlkZGVuLmpzcD9wbmFtZT1kWE5sY201aGJXVTlNakF4TURReU5pWk5RVWxPWDBsRVBWcEZUa2RLVlVGT1NsVkJUaVp3WVhOemQyOXlaRDB4TmpRNFpUZGlOREl4TmpJME1EVTFZMk15TmpSbVl6QmxOekkyWkRSaFkyUXdOemczWXpkaU1EQTFPVGt4TW1JNE1qSmhNR0l5TUdVMVlUZGxPREZrWkRFMk1qRTVOMkZtTXpZMU1EQXpPRGxqTkRWbU4ySmtNRFE0WmpNM1pXRTJNVGxqWWpJeVltUmhaalUwTmpneE9HRTNPREF6TW1JNU5ETmhabVJpT0RVeE5tWTFOek5sTmpNd05USXhaamRtTlRsaVlqSXpaR1E0WWpFd01UYzBKbk56YjE5MWMyVnlibUZ0WlQweU1ERXdOREkySm5OemIxOTBhV05yWlhROU1UWTBPR1UzWWpReU1UWXlOREExTldOak1qWTBabU13WlRjeU5tUTBZV05rTURjNE4yTTNZakF3TlRrNU1USmlPREl5WVRCaU1qQmxOV0UzWlRneFpHUXhOakl4T1RkaFpqTTJOVEF3TXpnNVl6UTFaamRpWkRBME9HWXpOMlZoTmpFNVkySXlNbUprWVdZMU5EWTRNVGhoTnpnd016SmlPVFF6WVdaa1lqZzFNVFptTlRjelpUWXpNRFV5TVdZM1pqVTVZbUl5TTJSa09HSXhNREUzTkNadmNEMDBRU1poY0hCZmRYTmxjbkJoY21GdFBUSXdNVEEwTWpZbVlYQndYM1JwWTJ0bGREMHhOalE0WlRkaU5ESXhOakkwTURVMVkyTXlOalJtWXpCbE56STJaRFJoWTJRd056ZzNZemRpTURBMU9Ua3hNbUk0TWpKaE1HSXlNR1UxWVRkbE9ERmtaREUyTWpFNU4yRm1NelkxTURBek9EbGpORFZtTjJKa01EUTRaak0zWldFMk1UbGpZakl5WW1SaFpqVTBOamd4T0dFM09EQXpNbUk1TkROaFptUmlPRFV4Tm1ZMU56TmxOak13TlRJeFpqZG1OVGxpWWpJelpHUTRZakV3TVRjMEptbHpSVzVqYjJSbFJtOXlVM052UFRFJTNEeiUyNiUyNiUyNmQ5MCZ1c2VybmFtZT0yMDEwNDI2Jk1BSU5fSUQ9WkVOR0pVQU5KVUFOJnBhc3N3b3JkPTE2NDhlN2I0MjE2MjQwNTVjYzI2NGZjMGU3MjZkNGFjZDA3ODdjN2IwMDU5OTEyYjgyMmEwYjIwZTVhN2U4MWRkMTYyMTk3YWYzNjUwMDM4OWM0NWY3YmQwNDhmMzdlYTYxOWNiMjJiZGFmNTQ2ODE4YTc4MDMyYjk0M2FmZGI4NTE2ZjU3M2U2MzA1MjFmN2Y1OWJiMjNkZDhiMTAxNzQmc3NvX3VzZXJuYW1lPTIwMTA0MjYmc3NvX3RpY2tldD0xNjQ4ZTdiNDIxNjI0MDU1Y2MyNjRmYzBlNzI2ZDRhY2QwNzg3YzdiMDA1OTkxMmI4MjJhMGIyMGU1YTdlODFkZDE2MjE5N2FmMzY1MDAzODljNDVmN2JkMDQ4ZjM3ZWE2MTljYjIyYmRhZjU0NjgxOGE3ODAzMmI5NDNhZmRiODUxNmY1NzNlNjMwNTIxZjdmNTliYjIzZGQ4YjEwMTc0Jm9wPTRBJmFwcF91c2VycGFyYW09MjAxMDQyNiZhcHBfdGlja2V0PTE2NDhlN2I0MjE2MjQwNTVjYzI2NGZjMGU3MjZkNGFjZDA3ODdjN2IwMDU5OTEyYjgyMmEwYjIwZTVhN2U4MWRkMTYyMTk3YWYzNjUwMDM4OWM0NWY3YmQwNDhmMzdlYTYxOWNiMjJiZGFmNTQ2ODE4YTc4MDMyYjk0M2FmZGI4NTE2ZjU3M2U2MzA1MjFmN2Y1OWJiMjNkZDhiMTAxNzQmaXNFbmNvZGVGb3JTc289MSxhY2NlcHQtbGFuZ3VhZ2U6emgtQ04sdXNlci1hZ2VudDpNb3ppbGxhLzUuMCAoV2luZG93cyBOVCAxMC4wOyBXT1c2NDsgVHJpZGVudC83LjA7IHJ2OjExLjApIGxpa2UgR2Vja28sYWNjZXB0LWVuY29kaW5nOmd6aXAsIGRlZmxhdGUsaG9zdDoxMC40OC4yMjQuMTAyOjkwMDUsY29ubmVjdGlvbjpLZWVwLUFsaXZlLGNvb2tpZTpOTEFQTS1QTEFURk9STT1pYm9wOyBOTEFQTS1DTElDSy1JRD0xN2NlYjE4Yzc3MzQ0MzkwOGIwMjVkNTU4NmI2MWUxM182OyBEV1JTRVNTSU9OSUQ9bm9sUkFPc0NIUzlDTjBpKkxQcko2TVZReHBwOyBKU0VTU0lPTklEPTFmOGU2YTQxNDAyNWUwZWIxMTg4YjFiNDdjZTg7IHNpZD0yNTQwMGYxZC1jYzU5LTRmOTgtYWJlNS1iNGZiMjIwMTg5MjQseC1mb3J3YXJkZWQtZm9yOjEwLjQ2LjIwLjMy" status_code="200" ip="10.46.20.32" collector="http://10.46.34.240:8089/nlapm/" trace_id="6661152.136.17454004242411377">
var cache_setTimeout = setTimeout;
eval("var setTimeout;");
(function() {
    //pageId生成规则
    function getUuid() {
        var s = [];
        var hexDigits = "0123456789abcdef";
        for (var i = 0; i < 36; i++) {
            s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
        }
        s[14] = "4";
        s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
        s[8] = s[13] = s[18] = s[23] = "-";

        var uuid = s.join("").replace(/-/g,"");
        return uuid;
    }
    function fromJson(str) {
        if (!str) return {};
        if ("undefined" != typeof JSON) {
            var parse = JSON.parse ? JSON.parse : JSON.decode;
            return parse.call(this, str);
        }
        return {};
    }
    function toJson(obj) {
        try{
            if ("undefined" != typeof JSON) {
                var stringify = JSON.stringify ? JSON.stringify : JSON.encode;
                var objJsonStr = stringify.call(this, obj);
                //RerouceTiming对象在IE下不支持toJSON方法，先将其转成普通对象
                if(objJsonStr === "{}"){
                    return stringify.call(this, extendObj({},obj));
                }
                return stringify.call(this, obj);
            }

            if (obj instanceof Array) {
                for (var t = [], n = 0; n < obj.length; n++) t.push(toJson(obj[n]));
                return "[" + t.join(",") + "]"
            }
            var r = [];
            for (var o in obj)
                if (obj.hasOwnProperty(o)) {
                    var i = '"' + o + '":', a = obj[o];
                    a && ("object" === typeof a? i += toJson(a) : "number" == typeof a ? i += a : i = i + '"' + a.replace(/\\/g, "\\\\").replace(/"/g, "\\\"").replace(/\r/g, "\\r").replace(/\n/g, "\\n")+ '"', r.push(i))
                }
            return "{" + r.join(",") + "}"
        }catch (e) {}
    }

    function extendObj(obj1,obj2){
        for(var key in obj2){
            if(key){
                obj1[key] = obj2[key];
            }
        }
        return obj1;
    }

    function getPerformanceByUrl(url) {
        if (url.indexOf(window.origin) === -1) {
            if (url.indexOf("/") !== 0) {
                url += "/" + url;
            }
            url = window.origin + url;
        }
        if(window.performance === undefined || typeof window.performance.getEntries !== 'function') return [];
        return  url ? fromJson(toJson(window.performance.getEntriesByName(url))) : [];
    }

    function trim(str){
        if(str){
            return str.replace(/[\s\uFEFF\xA0]+/g,'');
        }else {
            return str;
        }
    }

    var nlapmPlugin = {
        pageId: getUuid(),
        waitInstanceQuery: true,
        waitSendList: [],
        parentPageId: "", //iframe可以获取父页面的pageId
        businessName: "",
        event: undefined, // 当页面发生点击事件时缓存event对象，如果是子页面调用父页面的方法发起请求就从这里面取clickId
        prepare: {
            clearNLAPMCookie: function () {
                var keys = nlapmPlugin.docCookies.keys();
                for (var i = 0; i < keys; i++) {
                    var key = keys[i];
                    if (key.indexOf("NLAPM") > -1) {
                        nlapmPlugin.docCookies.removeItem(key)
                    }
                }
            },
            initPageInfo: function () {
                var info = nlapmPluginInit || {};
                var keys = Object.keys(info);
                if (keys.length > 0) {
                    for (var i = 0; i < keys; i++) {
                        var key = keys[i];
                        nlapmPlugin.docCookies.setItem(key, info[key])
                    }
                }
                nlapmPlugin.docCookies.setItem("NLAPM_" + (keys.length + 1), nlapmPlugin.util.toJson({a:keys.length, b: "ccc\"a\"d", c: "aaa"}))
            },
            getIBOPBaseInfo: function () {
                // nlapmPlugin.collector.headScriptInfo.collector = "http://localhost:9118/";
                var parent_url = window.parent != window ? window.parent.document.location.href : "";
                // var previous_page_info = sessionStorage.getItem(parent_url) || sessionStorage.getItem(document.referrer || "") || sessionStorage.getItem(window.name || "");
                var previous_page_info = sessionStorage.getItem(parent_url) || sessionStorage.getItem(document.referrer || "");
                nlapmPlugin.collector.currentSessionCache = toJson(previous_page_info);
                if (previous_page_info) {
                    nlapmPlugin.prepare.setPageCache(fromJson(previous_page_info));
                } else {
                    nlapmPlugin.sender.ajaxSend({
                        url: "nlapm-ibop-business/businesss/businessRel",
                        data: {
                            url: window.location.href
                        },
                        retryCount: 0,
                        error: function () {
                            nlapmPlugin.prepare.setPageCache({
                                b_name: "",
                                b_instance_id: "",
                                b_start_time: "",
                                b_other: [],
                            });
                        },
                        callback : function (result) {
                            result.data && nlapmPlugin.prepare.setPageCache(result.data)
                        }
                    });
                    // nlapmPlugin.prepare.setPageCache({
                    //     b_name: nlapmPlugin.collector.headScriptInfo.b_name,
                    //     b_instance_id: nlapmPlugin.collector.headScriptInfo.b_instance_id
                    // });
                }
            },
            setPageCache: function (b_info) {
                // if (b_info.exclude) return ;
                if (!b_info.page_url || b_info.page_url == window.location.href) {
                    b_info.b_start_time = new Date().getTime();
                    b_info.b_instance_id = getUuid();
                } else {
                    var other = b_info.b_other || [];
                    for (var j = 0; j < other.length; j++) {
                        if (other[j].page_url == window.location.href) {
                            b_info.b_name = other[j].b_name;
                            b_info.b_start_time = new Date().getTime();
                            b_info.b_instance_id = getUuid();
                            b_info.b_other = [];
                            break;
                        }
                    }
                }
                b_info.page_url = window.location.href;
                nlapmPlugin.collector.pageRouteCache = {
                    b_name: b_info.b_name,
                    b_instance_id: b_info.b_instance_id,
                    b_start_time: b_info.b_start_time
                }
                nlapmPlugin.waitInstanceQuery = false;
                if (b_info.b_name && b_info.b_name.replace(/ /ig, '') != "") {
                    sessionStorage.setItem(window.location.href, toJson(b_info));
                    // window.name != "" && sessionStorage.setItem(window.name, toJson(b_info));
                }
                for (var i = 0; i < nlapmPlugin.waitSendList.length; i++) {
                    var option = nlapmPlugin.waitSendList[i];
                    option.data.bName = nlapmPlugin.collector.pageRouteCache.b_name;
                    option.data.bInstanceId = nlapmPlugin.collector.pageRouteCache.b_instance_id;
                    option.data.bStartTime = nlapmPlugin.collector.pageRouteCache.b_start_time;
                    option.data = nlapmPlugin.sender.createFlumeAcceptData(option.type,option.data);
                    nlapmPlugin.sender.ajaxSend(option);
                }
            },
            initBusinessName: function () {
                if (parent == window) return ;
                if (! parent.nlapmPlugin ) return ;
                nlapmPlugin.businessName = parent.nlapmPlugin.businessName == ""
                    ? window.location.href
                    : parent.nlapmPlugin.businessName;
            },
            initScriptInfo: function(){
                var headScript;
                if(document.currentScript){
                    headScript = document.currentScript;
                }else {
                    var js = document.scripts;
                    headScript = js[js.length-1];
                }
                if(headScript){
                    nlapmPlugin.collector.headScriptInfo.traceId = headScript.getAttribute("trace_id");
                    nlapmPlugin.collector.headScriptInfo.requestHeader = headScript.getAttribute("req_head");
                    nlapmPlugin.collector.headScriptInfo.requestBody = headScript.getAttribute("req_body");
                    nlapmPlugin.collector.headScriptInfo.statusCode = headScript.getAttribute("status_code");
                    nlapmPlugin.collector.headScriptInfo.collector = headScript.getAttribute("collector");
                    nlapmPlugin.collector.headScriptInfo.clientIp = headScript.getAttribute("ip");
                    nlapmPlugin.collector.headScriptInfo.platform = headScript.getAttribute("platform");//平台标识
                    if(nlapmPlugin.collector.headScriptInfo.platform)
                        nlapmPlugin.docCookies.setItem("NLAPM-PLATFORM", nlapmPlugin.collector.headScriptInfo.platform);
                    nlapmPlugin.collector.headScriptInfo.clickId = headScript.getAttribute("click_id");//上个页面的点击ID
                    // nlapmPlugin.collector.headScriptInfo.b_name = headScript.getAttribute("b_name");
                    // nlapmPlugin.collector.headScriptInfo.b_instance_id = headScript.getAttribute("b_instance_id");
                }
            }
        },
        collector: {
            //获取标签中的trace_id等信息
            headScriptInfo: {
                traceId: "",
                requestHeader: "",
                requestBody: "",
                statusCode: "",
                collector: "",
                clientIp: "",
                platform: "",
                clickId: "",
                b_name: "",
                b_instance_id: ""
            },
            startScriptTime: new Date().getTime(),
            IEPageInfo: {
                name: window.location.href,
                domInteractive: 0,
                domComplete: 0,
                loadEventStart: 0,
                loadEventEnd: 0,
                duration: 0
            },
            pageRouteCache: {
                exclude: true
            },
            clickSeq: 0,
            requestSeq: 0,//请求序列号
            clickId: "",
            clickHtml: "",
            currentCollectResourceTimingIndex: 0,
            genClickId: function () {
                nlapmPlugin.collector.clickId = getUuid() + "_" + nlapmPlugin.collector.clickSeq++;
                // return nlapmPlugin.pageId + "_" + nlapmPlugin.collector.clickSeq;
            },
            getClickId: function () {
                return nlapmPlugin.collector.clickId;
            },
            getRequestId: function () {
                return getUuid() + "_" + nlapmPlugin.collector.requestSeq++;
                // return nlapmPlugin.pageId + "_" + this.requestSeq++;
            },
            saveEnvToTarget: function (cacheObj) {
                if(cacheObj.ignoreThisRequest) return;
                cacheObj.clickSeq = nlapmPlugin.collector.clickSeq;
                cacheObj.clickHtml = nlapmPlugin.collector.clickHtml;
                cacheObj.clickId = nlapmPlugin.collector.clickId;
                // console.log("当前缓存ENV内容: clickId=" + cacheObj.clickId);
            },
            cacheBeforeCallback: function (cacheObj) {
                if(cacheObj.ignoreThisRequest) return;
                cacheObj.newest_seq = nlapmPlugin.collector.clickSeq;
                cacheObj.newest_html = nlapmPlugin.collector.clickHtml;
                cacheObj.newest_clickId = nlapmPlugin.collector.clickId;
                nlapmPlugin.collector.clickSeq = cacheObj.clickSeq;
                nlapmPlugin.collector.clickHtml = cacheObj.clickHtml;
                nlapmPlugin.collector.clickId = cacheObj.clickId;
                // console.log("before 缓存: clickId=" + cacheObj.newest_clickId);
                // console.log("before 恢复: clickId=" + nlapmPlugin.collector.clickId);
            },
            restoreAfterCallback: function (cacheObj) {
                if(cacheObj.ignoreThisRequest) return;
                cacheObj.newest_seq && (nlapmPlugin.collector.clickSeq = cacheObj.newest_seq);
                cacheObj.newest_html && (nlapmPlugin.collector.clickHtml = cacheObj.newest_html);
                cacheObj.newest_clickId && (nlapmPlugin.collector.clickId = cacheObj.newest_clickId);
                // console.log("restore: clickId=" + nlapmPlugin.collector.clickId);
            },
            collectXHRInfo: function (){
                if (!window.XMLHttpRequest || !window.XMLHttpRequest.prototype) return;
                var old_open = XMLHttpRequest.prototype.open;
                XMLHttpRequest.prototype.open = function (method, url) {
                    // 保存当前需要存储的环境变量
                    nlapmPlugin.collector.saveEnvToTarget(this);
                    if(!this.ignoreThisRequest){
                        this.requestInfo = {
                            method: method,
                            url: url,
                            startTime: (new Date()).getTime(),
                            requestId: nlapmPlugin.collector.getRequestId(),
                            clickId: nlapmPlugin.collector.getClickId()
                        };
                    }
                    old_open && old_open.apply(this, arguments);
                    if(!this.ignoreThisRequest) {
                        this.setRequestHeader("NLAPM-CLIENT-EVENT-ID", this.requestInfo.requestId);
                    }
                };

                var old_send = XMLHttpRequest.prototype.send;
                XMLHttpRequest.prototype.send = function (body) {
                    try {
                        if (!this.ignoreThisRequest && this.requestInfo) {
                            var xmlHttp = this;
                            xmlHttp.requestInfo.Recorded = !1;
                            xmlHttp.requestInfo.body = body;
                            var old_onloadend = xmlHttp.onloadend;

                            var data = {
                                bName: nlapmPlugin.collector.pageRouteCache.b_name,
                                bInstanceId: nlapmPlugin.collector.pageRouteCache.b_instance_id,
                                bStartTime: nlapmPlugin.collector.pageRouteCache.b_start_time,

                                // requestStart: xmlHttp.requestInfo.startTime,
                                clickId: xmlHttp.requestInfo.clickId,
                                businessName: nlapmPlugin.businessName,
                                entryType: 'resource',
                                initiatorType: 'xmlhttprequest',
                                name: xmlHttp.responseURL || xmlHttp.requestInfo.url,
                                pageId: nlapmPlugin.pageId,
                                pageName: window.location.href,
                                method: this.requestInfo.method,
                                requestBody: body,
                                requestTime: new Date().getTime(),
                                requestId: xmlHttp.requestInfo.requestId,
                                requestIp: nlapmPlugin.collector.headScriptInfo.clientIp,
                                requestHeader: "",
                                pageRequestHeader: nlapmPlugin.collector.headScriptInfo.requestHeader,
                                userAgent: window.navigator.userAgent
                            };

                            if(typeof dwr !== "undefined" && dwr.engine && dwr.engine.oper_flag && dwr.engine.oper_flag.c) {
                                data.encryptKey = dwr.engine.oper_flag.c;
                            }

                            if(window.performance) {
                                data.navigationStart = window.performance.timing.navigationStart
                            }

                            if (old_onloadend === undefined) {
                                var old_onstatechange = xmlHttp.onreadystatechange;
                                xmlHttp.onreadystatechange = function () {
                                    // 缓存当前全局clickId
                                    nlapmPlugin.collector.cacheBeforeCallback(this);
                                    try { typeof old_onstatechange === 'function' && old_onstatechange.apply(this, arguments); }
                                    finally {// 还原全局click ID
                                        nlapmPlugin.collector.restoreAfterCallback(this);
                                    }
                                    try {
                                        //readyState = 4请求完成
                                        if (xmlHttp.readyState < 4 || xmlHttp.requestInfo.Recorded)
                                            return;
                                        data.responseEnd = new Date().getTime();
                                        data.traceId = xmlHttp.getResponseHeader('NLAPM-TRACEID');
                                        data.requestHeader = trim(xmlHttp.getResponseHeader("NLAPM-REQH"));
                                        data.responseHeader = nlapmPlugin.collector.handleXHRResponseHeader(xmlHttp.getAllResponseHeaders());
                                        data.responseBody = xmlHttp.responseText && xmlHttp.responseText.length > 4000 ? xmlHttp.responseText.substring(0, 4000) : xmlHttp.responseText;
                                        data.status = xmlHttp.status;
                                        data.duration = data.responseEnd - data.requestTime;
                                        data.type = "end";
                                        nlapmPlugin.sender.sendCollectData({
                                            type: "request",
                                            url: "request",
                                            data: data,
                                            callback: function () {}
                                        });
                                        xmlHttp.requestInfo.Recorded = !0;
                                    }catch (e) {}
                                }
                            }


                            var old_onprogress = this.onprogress;
                            this.onprogress = function () {
                                nlapmPlugin.collector.cacheBeforeCallback(this);
                                try { typeof old_onprogress === 'function' && old_onprogress.apply(this, arguments); }
                                finally {// 还原全局click ID
                                    // nlapmPlugin.collector.restoreAfterCallback(this);
                                }
                            };

                            this.onloadend = function () {

                                try {
                                    if (xmlHttp.requestInfo.Recorded) return;
                                    if (xmlHttp.status === 200) {
                                        var ajs = getPerformanceByUrl(data.name);
                                        if (ajs.length > 0) {
                                            //取最后一个
                                            extendObj(data, ajs[ajs.length - 1]);
                                        }
                                        xmlHttp.requestInfo.Recorded = !0;
                                    }
                                    data.responseEnd = new Date().getTime();
                                    data.status = xmlHttp.status;
                                    data.responseBody = xmlHttp.responseText && xmlHttp.responseText.length > 4000 ?xmlHttp.responseText.substring(0, 4000) : xmlHttp.responseText;
                                    data.responseHeader = nlapmPlugin.collector.handleXHRResponseHeader(xmlHttp.getAllResponseHeaders());
                                    data.traceId = xmlHttp.getResponseHeader('NLAPM-TRACEID');
                                    data.requestHeader = trim(xmlHttp.getResponseHeader("NLAPM-REQH"));
                                    data.type = "end";
                                    // extendObj(data,nlapmPlugin.collector.handleRequestHeader(data.requestHeader));
                                    nlapmPlugin.sender.sendCollectData({
                                        type: "request",
                                        url: "request",
                                        data: data,
                                        callback: function () {}
                                    });
                                } catch (e) {}

                                // nlapmPlugin.collector.cacheBeforeCallback(this);
                                try { old_onloadend && old_onloadend.apply(this, arguments); }
                                finally {
                                    nlapmPlugin.collector.restoreAfterCallback(this);
                                }
                            }
                        }
                    }catch (r) {}
                    // var old_onprogress = this.onCompleted;
                    old_send && old_send.apply(this, arguments);
                };

            },
            collectClickInfo: function () {
                var clickEventListener = function(e) {
                    var target, outerHTML = (target = e.target ? e.target : e.srcElement) && target.outerHTML;
                    if ( target.tagName &&  target.tagName.toLocaleUpperCase() === "HTML") return ;
                    // 增长clickID
                    nlapmPlugin.collector.genClickId();
                    //点击事件数据
                    var clickData = {
                        bName: nlapmPlugin.collector.pageRouteCache.b_name,
                        bInstanceId: nlapmPlugin.collector.pageRouteCache.b_instance_id,
                        bStartTime: nlapmPlugin.collector.pageRouteCache.b_start_time,
                        pageId: nlapmPlugin.pageId,
                        businessName: nlapmPlugin.businessName,
                        pageName: window.location.href,
                        outerHtml: outerHTML && outerHTML.length > 300 ? outerHTML.substring(0, 300) : outerHTML,
                        tagName: target && target.tagName,
                        elementId: target && target.id,
                        className: target && target.className,
                        name: target && target.name,
                        clickTime: (new Date).getTime(),
                        // clickId: clickId,
                        clickId: nlapmPlugin.collector.getClickId(),
                        isTrusted: e.isTrusted,
                        screenX  : e.screenX,
                        screenY  : e.screenY,
                        clientX  : e.clientX,
                        clientY  : e.clientY,
                        pageX    : e.pageX,
                        pageY    : e.pageY,
                        offsetX  : e.offsetX,
                        offsetY  : e.offsetY,
                        ctrlKey  : e.ctrlKey,
                        shiftKey : e.shiftKey,
                        altKey   : e.altKey,
                        metaKey  : e.metaKey
                    };
                    nlapmPlugin.collector.clickHtml = clickData.outerHtml;
                    if(typeof dwr !== "undefined" && dwr.engine && dwr.engine.oper_flag && dwr.engine.oper_flag.c){
                        clickData.encryptKey = dwr.engine.oper_flag.c;
                    }
                    clickData.pageRequestHeader = nlapmPlugin.collector.headScriptInfo.requestHeader;
                    //获取点击之后的js内存使用信息
                    nlapmPlugin.collector.getCurMemoryInfoToObj(clickData);
                    nlapmPlugin.docCookies.setItem("NLAPM-CLICK-ID", clickData.clickId);

                    nlapmPlugin.sender.sendCollectData({
                        type: "click",
                        url: "click",
                        data: clickData
                    });
                };
                window.addEventListener ? window.addEventListener("click", clickEventListener, !0) : document.attachEvent("onclick", clickEventListener)
            },
            collectJsErrorInfo: function () {
                var old_error_operator = window.onerror;
                window.onerror = function (msg, url, lineNo, columnNo, error) {
                    if (typeof old_error_operator ==='function') old_error_operator.apply(this, arguments);
                    var string = msg.toString().toLowerCase();
                    var substring = "script error";
                    // if (string.indexOf(substring) > -1) {
                    nlapmPlugin.sender.sendCollectData({
                        type: "error",
                        url: "error",
                        data: {
                            bName: nlapmPlugin.collector.pageRouteCache.b_name,
                            bInstanceId: nlapmPlugin.collector.pageRouteCache.b_instance_id,
                            bStartTime: nlapmPlugin.collector.pageRouteCache.b_start_time,
                            pageId: nlapmPlugin.pageId,
                            businessName: nlapmPlugin.businessName,
                            message: msg,
                            location: location.href,
                            lineNo: lineNo,
                            columnNo: columnNo,
                            errorStack: error ? error.stack : "",
                            time: (new Date()).getTime(),
                            pageName: window.location.href,
                            clickId: nlapmPlugin.collector.getClickId(),
                            userAgent: navigator.userAgent,
                            errorType: string.indexOf(substring) > -1 ? "script" : "other",
                            requestHeader: nlapmPlugin.collector.headScriptInfo.requestHeader
                        }
                    });
                };
            },
            sendTestError: function () {
                throw new Error("script test error");
                // if (a =='a') {}
            },
            getCurMemoryInfoToObj: function (data){
                if(window.performance && window.performance.memory){
                    data.jsHeapSizeLimit = window.performance.memory.jsHeapSizeLimit;
                    data.totalJsHeapSize = window.performance.memory.totalJSHeapSize;
                    data.usedJsHeapSize = window.performance.memory.usedJSHeapSize;
                    // extendObj(data,window.performance.memory);
                }
            },
            //页面点击之后如果新的资源就采集 在onload中调用
            updateResource: function () {
                if(!window.performance){
                    return;
                }

                var resourceData = window.performance.getEntriesByType("resource");
                var collectResrouces = [];
                for(var ind = nlapmPlugin.collector.currentCollectResourceTimingIndex;ind < resourceData.length;ind++){
                    if(resourceData[ind].initiatorType != "xmlhttprequest"){
                        var resourceDataObj = fromJson(toJson(resourceData[ind]));
                        resourceDataObj.pageId = nlapmPlugin.pageId;
                        resourceDataObj.platform = nlapmPlugin.collector.headScriptInfo.platform;
                        resourceDataObj.pageName = window.location.href;
                        resourceDataObj.businessName = nlapmPlugin.businessName;
                        resourceDataObj.navigationStart = performance.timing.navigationStart;
                        resourceDataObj.bName = nlapmPlugin.collector.pageRouteCache.b_name;
                        resourceDataObj.bInstanceId = nlapmPlugin.collector.pageRouteCache.b_instance_id;
                        resourceDataObj.bStartTime = nlapmPlugin.collector.pageRouteCache.b_start_time;
                        collectResrouces.push(resourceDataObj);
                        //记录资源性能下标，防止重复采集
                        nlapmPlugin.collector.currentCollectResourceTimingIndex = ind + 1;
                    }
                }

                if(collectResrouces.length > 0){
                    nlapmPlugin.sender.sendCollectData({
                        type: "resource",
                        url: "resource",
                        data: collectResrouces
                    });
                }
            },
            overrideSetTimeoutAndSetInterval: function () {
                window.setTimeout = function (vCallback, nDelay) {
                    var cacheObj = {};
                    nlapmPlugin.collector.saveEnvToTarget(cacheObj);
                    var old_handle = typeof vCallback === "string" ? function () { eval(vCallback); } : vCallback;
                    var new_handle = function () {
                        nlapmPlugin.collector.cacheBeforeCallback(cacheObj);
                        try { old_handle && old_handle.apply(this, arguments); }
                        finally {
                            nlapmPlugin.collector.restoreAfterCallback(cacheObj);
                        }
                    };
                    return cache_setTimeout(new_handle, nDelay);
                };
                setTimeout = window.setTimeout;
            },
            //去掉responseHeader中NLAPM-TRACEID以及NLAPM-REQ
            handleXHRResponseHeader: function (responseHeader) {
                var arr = responseHeader.split("\r\n");
                var responseHeaderArr = [];
                for(var i = 0;i < arr.length;i++){
                    var header = arr[i];
                    var headerContentArr = header.split(":");
                    var headerKey = headerContentArr[0];
                    if(headerKey === "nlapm-reqh" || headerKey === "nlapm-traceid"){
                        continue;
                    }
                    responseHeaderArr.push(header);
                }

                return responseHeaderArr.join("\r\n");
            }
        },
        sender: {
            createFlumeAcceptData: function(type,data) {
                data.platform = nlapmPlugin.collector.headScriptInfo.platform;
                if(data instanceof Array){
                    var sendData = [];
                    for(var i = 0;i < data.length;i++){
                        sendData.push({
                            headers: {
                                "topic": "nlapm-web-" + type + "-from-nginx"
                            },
                            body: toJson(data[i])
                        });
                    }
                    return sendData;
                }else if(data instanceof Object){
                    return [{
                        headers: {
                            "topic": "nlapm-web-" + type + "-from-nginx"
                        },
                        body: toJson(data)
                    }];
                }
            },
            sendCollectData: function(option){
                if (nlapmPlugin.waitInstanceQuery) {
                    nlapmPlugin.waitSendList.push(option);
                    return;
                }
                option.data = this.createFlumeAcceptData(option.type,option.data);
                this.ajaxSend(option);
            },
            ajaxSend: function(option){
                if (window.XMLHttpRequest && window.atob) {
                    var xmlhttp = new XMLHttpRequest;
                    xmlhttp.ignoreThisRequest = true;
                    xmlhttp.open(option.method === undefined ? 'POST' : option.method.toUpperCase(),
                        nlapmPlugin.collector.headScriptInfo.collector + option.url,
                        option.async === undefined ? true : option.async);
                    // xmlhttp.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
                    xmlhttp.timeout = 10000;
                    option.retryCount = typeof option.retryCount === "number"?option.retryCount:2;
                    //重试
                    var reTry = function () {
                        if(option.retryCount > 0){
                            option.retryCount--;
                            nlapmPlugin.sender.ajaxSend(option);
                        } else {
                            ('function' === typeof option.error && option.error.apply(this, []));
                        }
                    };
                    xmlhttp.onreadystatechange = function () {
                        if (this.readyState === 4) {
                            try {
                                if (this.status >= 200 && this.status < 300) {
                                    ('function' === typeof option.callback && option.callback(fromJson(xmlhttp.responseText)));
                                } else {
                                    reTry.apply(this, arguments);
                                }
                            }catch(e){ }
                        }
                    };
                    xmlhttp.onerror = reTry;
                    xmlhttp.ontimeout = reTry;

                    xmlhttp.send(toJson(option.data));
                }else{
                    // if(option.data.indexOf("dynaTraceMonitor") === -1){
                    try {
                        var xdr = new XDomainRequest();
                        xdr.open(option.method === undefined ? 'POST' : option.method.toUpperCase(),
                            nlapmPlugin.collector.headScriptInfo.collector + option.url);
                        xdr.onload = function() {
                            ('function' === typeof option.callback && option.callback(fromJson(xdr.responseText)));
                        }
                        xdr.onerror = function() {
                            ('function' === typeof option.error && option.error(fromJson(xdr.responseText)));
                        }
                        xdr.send(toJson(option.data));
                    } catch (e) {}
                    // }
                }
            }
        },
        util: {
            toJson: toJson,
            fromJson: fromJson,
            extendObj: function (obj1,obj2){
                for(var key in obj2){
                    if(key){
                        obj1[key] = obj2[key];
                    }
                }
                return obj1;
            },
            ie8: function () {
                var ua = navigator.userAgent.toLowerCase();
                var isIE = ua.indexOf("msie")>-1;
                var safariVersion;
                if(isIE){
                    safariVersion =  ua.match(/msie ([\d.]+)/)[1];
                }
                return safariVersion === "8.0";
            }
        },
        docCookies: {
            getItem: function (sKey) {
                return decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*" + encodeURIComponent(sKey).replace(/[-.+*]/g, "\\$&") + "\\s*\\=\\s*([^;]*).*$)|^.*$"), "$1")) || null;
            },
            setItem: function (sKey, sValue, vEnd, sPath, sDomain, bSecure) {
                if (!sKey || /^(?:expires|max\-age|path|domain|secure)$/i.test(sKey)) { return false; }
                var sExpires = "";
                if (vEnd) {
                    switch (vEnd.constructor) {
                        case Number:
                            sExpires = vEnd === Infinity ? "; expires=Fri, 31 Dec 9999 23:59:59 GMT" : "; max-age=" + vEnd;
                            break;
                        case String:
                            sExpires = "; expires=" + vEnd;
                            break;
                        case Date:
                            sExpires = "; expires=" + vEnd.toUTCString();
                            break;
                    }
                }
                document.cookie = encodeURIComponent(sKey) + "=" + encodeURIComponent(sValue) + sExpires + (sDomain ? "; domain=" + sDomain : "") + (sPath ? "; path=" + sPath : "") + (bSecure ? "; secure" : "");
                return true;
            },
            removeItem: function (sKey, sPath, sDomain) {
                if (!sKey || !this.hasItem(sKey)) { return false; }
                document.cookie = encodeURIComponent(sKey) + "=; expires=Thu, 01 Jan 1970 00:00:00 GMT" + ( sDomain ? "; domain=" + sDomain : "") + ( sPath ? "; path=" + sPath : "");
                return true;
            },
            hasItem: function (sKey) {
                return (new RegExp("(?:^|;\\s*)" + encodeURIComponent(sKey).replace(/[-.+*]/g, "\\$&") + "\\s*\\=")).test(document.cookie);
            },
            keys: function () {
                var aKeys = document.cookie.replace(/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g, "").split(/\s*(?:\=[^;]*)?;\s*/);
                for (var nIdx = 0; nIdx < aKeys.length; nIdx++) { aKeys[nIdx] = decodeURIComponent(aKeys[nIdx]); }
                return aKeys;
            }
        },
        start: function () {
            //兼容DT
            if(window.dT_){
                var m = window.XMLHttpRequest;
                var fun=["abort","setRequestHeader","getResponseHeader","getAllResponseHeaders"];
                for (var i=0,l=fun.length;i<l;i++) {
                    var c=fun[i];
                    if (!window.EventTarget || "addEventListener" !== c && "removeEventListener" !== c && "dispatchEvent" !== c)
                        try {
                            var s  = m.prototype[c];
                            if (s && typeof s == "function" || typeof s == "object") {
                                XMLHttpRequestReWrite(c);
                            }
                        } catch (e) {

                        }
                }
                function XMLHttpRequestReWrite(c){
                    try {
                        var s  = window.XMLHttpRequest.prototype[c];
                        if (s && typeof s == "function" || typeof s == "object") {
                            window.XMLHttpRequest.prototype[c] = function () {
                                return s.apply(this, arguments);
                            }
                        }
                    } catch (e) {

                    }
                }
            }

            //IE DOM渲染阶段耗时
            document.onreadystatechange = function () {
                if ('interactive' === document.readyState) {
                    nlapmPlugin.collector.IEPageInfo.domInteractive = new Date().getTime() - nlapmPlugin.collector.startScriptTime;
                }
                if ('complete' === document.readyState) {
                    nlapmPlugin.collector.IEPageInfo.domComplete = new Date().getTime() - nlapmPlugin.collector.startScriptTime;
                }
            };
            if(parent !== window && parent.nlapmPlugin){
                nlapmPlugin.parentPageId = parent.nlapmPlugin.pageId;
            }
            // when start script gen clickID
            nlapmPlugin.collector.genClickId();
            // nlapmPlugin.prepare.initPageInfo();
            nlapmPlugin.prepare.initScriptInfo();
            nlapmPlugin.prepare.getIBOPBaseInfo();
            nlapmPlugin.prepare.initBusinessName();
            nlapmPlugin.collector.collectXHRInfo();
            nlapmPlugin.collector.collectClickInfo();
            nlapmPlugin.collector.collectJsErrorInfo();
            nlapmPlugin.collector.overrideSetTimeoutAndSetInterval();
        }
    };
    nlapmPlugin.start();
    window.nlapmPlugin = nlapmPlugin;
})();
</script>